<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="_fragments :: head(~{::title})">
    <meta charset="UTF-8">
</head>
<body>

                    <!--明日方舟公开招募计算器[20200210]-start-->
                    <!--内容[注意删除Tab，空行！！！]-->
                    <div class="row mt-3">
                        <div class="col-12 col-lg-4 px-2">
                            <div class="alert alert-dark px-2 py-1" role="alert">
                                <table class="table table-sm m-0">
                                    <tbody id="box-options">
                                    <tr>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger my-1" id="btn-clear">
                                                    <span class="cn" style="display: inline;">清空</span>
                                                    <span class="en">Clear</span>
                                                </button>
                                                <span class="d-none d-sm-inline">
                                            <button type="button" class="btn btn-sm btn-primary btn-showopt my-1 btn-name" opt-id="showName">
                                                <span class="cn" style="display: inline;">名称</span>
                                                <span class="en">Name</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-showopt my-1 btn-image btn-primary" opt-id="showImage">
                                                <span class="cn" style="display: inline;">图片</span>
                                                <span class="en">Image</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-showopt my-1 btn-imgsize btn-imgsizedefault btn-primary" sizeval="27">
                                                <span class="cn" style="display: inline;">小</span>
                                                <span class="en">Small</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-showopt my-1 btn-imgsize btn-secondary" sizeval="45">
                                                <span class="cn" style="display: inline;">中</span>
                                                <span class="en">Middle</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-showopt my-1 btn-imgsize btn-secondary" sizeval="80">
                                                <span class="cn" style="display: inline;">大</span>
                                                <span class="en">Large</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-showopt my-1 btn-imgsize btn-secondary" sizeval="128">
                                                <span class="cn" style="display: inline;">特大</span>
                                                <span class="en">Ex-large</span>
                                            </button>
                                        </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-secondary" opt-id="all" id="opt-all">ALL</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-primary" opt-id="6">6★</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-primary" opt-id="5">5★</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-primary" opt-id="4">4★</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-primary" opt-id="3">3★</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-secondary" opt-id="2">2★</button>
                                            <button type="button" class="btn btn-sm btn-opt my-1 btn-secondary" opt-id="1">1★</button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <table class="table table-sm m-0">
                                    <tbody id="box-tags">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-12 col-lg-8 px-0">
                            <table class="table table-striped table-hover" id="table-recommend">
                                <thead class="thead-dark">
                                <tr>
                                    <th scope="col" class="d-none d-sm-table-cell">#</th>
                                    <th scope="col" style="width:16.67%">Tags</th>
                                    <th scope="col">
                                        <span class="cn" style="display: inline;">可能出现</span>
                                    </th>
                                    <th scope="col" class="d-none d-sm-table-cell">$~</th>
                                </tr>
                                </thead>
                                <tbody id="tbody-recommend"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 text-left cn" style="display: block;">
                        <p>使用说明：</p>
                        <p>1. 勾选需要查询的Tag，最多6个；</p>
                        <p>2. 勾选需要查询的星级，默认全部；</p>
                        <p>3. 现在点击标签即可开始计算，可点击“清空”重新开始；</p>
                        <p>4. 可以点击推荐表格中的干员或标签进行精准查询，再点击任意干员或标签返回。</p>
                    </div>
                    <div class="col-12 alert alert-success mt-1 cn" role="alert">
                        20/02/08 若遇到无法打开的错误，<a href="https://ak.graueneko.xyz/akhr.html">请访问原本站链接。</a>
                    </div>
                    <div class="col-12 alert alert-success mt-1 cn" role="alert">
                        19/12/24 公开招募干员池已随游戏同步更新。
                    </div>
                    <div class="col-12 alert alert-success mt-1 cn" role="alert" style="display: block;">
                        19/06/13 明日方舟工具箱(新版) 上线：更多功能，更快加载，<a href="https://aktools.graueneko.xyz">欢迎点击此处使用。</a>(数据保持同步更新)
                    </div>
                    <div class="row col-12 page-footer">
                        <div class="col-12 text-center cn" style="display: block;">
                            <p>最近更新：2019/12/24，<a href="https://bbs.nga.cn/read.php?tid=16971344">联系作者</a></p>
                            <p>
                                数据来源：
                                <a href="http://wiki.joyme.com/arknights/%E5%B9%B2%E5%91%98%E6%95%B0%E6%8D%AE%E8%A1%A8">明日方舟Wiki</a>
                            </p>
                            <p>Powered by 一只灰猫。</p>
                        </div>
                    </div>
                    <!--js-->
                    <script src="/js/tool/mrfz/jquery-3.4.0.min.js"></script>
                    <script src="/js/tool/mrfz/akcustom.js"></script>
                    <script src="/js/tool/mrfz/popper.min.js"></script>
                    <script src="/js/tool/mrfz/bootstrap.min.js"></script>
                    <script type="text/javascript">
                        $(function () {
                            let lang = getLang();
                            let initialized = false;
                            showCurrentLang();
                            document.title = {
                                "cn": "明日方舟公开招募计算器",
                                "en": "Arknights Recruitment Recommender",
                                "jp": "明日方舟公开招募计算器"
                            }[lang];
                            let tags = [
                                {
                                    "cn": "资质", "cntags": ["新手", "资深干员", "高级资深干员"],
                                    "en": "Qualification", "entags": ["Starter", "Senior Operator", "Top Operator"],
                                    "jp": "资质", "jptags": ["新手", "资深干员", "高级资深干员"]
                                },
                                {
                                    "cn": "位置", "cntags": ["远程位", "近战位"],
                                    "en": "Position", "entags": ["Ranged", "Melee"],
                                    "jp": "位置", "jptags": ["远程位", "近战位"]
                                },
                                {
                                    "cn": "种类", "cntags": ["先锋干员", "狙击干员", "医疗干员", "术师干员", "近卫干员", "重装干员", "辅助干员", "特种干员"],
                                    "en": "Class", "entags": ["Vanguard", "Sniper", "Medic", "Caster", "Guard", "Defender", "Support", "Specialist"],
                                    "jp": "种类", "cntags": ["先锋干员", "狙击干员", "医疗干员", "术师干员", "近卫干员", "重装干员", "辅助干员", "特种干员"]
                                },
                                {
                                    "cn": "词缀", "cntags": ["治疗", "支援", "输出", "群攻", "减速", "生存", "防护", "削弱", "位移", "控场", "爆发", "召唤", "快速复活", "费用回复", "支援机械"],
                                    "en": "Affix", "entags": ["Healing", "Support", "DPS", "AoE", "Slow", "Survival", "Defense", "Debuff", "Shift", "Crowd Control", "Nuker", "Summoner", "Fast-Redeploy", "DP-Recovery", "Robot"],
                                    "jp": "词缀", "cntags": ["治疗", "支援", "输出", "群攻", "减速", "生存", "防护", "削弱", "位移", "控场", "爆发", "召唤", "快速复活", "费用回复", "支援机械"]
                                }
                            ];
                            $.each(tags, (_, v) => {
                                let row = '<tr><td><button class="btn btn-sm btn-info my-1" disabled>' + v[lang] + '</button></td><td>';
                                let tags_btn = []
                                for (let i = 0; i < v['cntags'].length; i++) {
                                    tags_btn.push('<button type="button" class="btn btn-sm btn-secondary btn-tag my-1" ' +
                                        (lang === 'cn' ? '' : ('data-toggle="tooltip" data-placement="top" title="' + v[lang + 'tags'][i] + '"'))
                                        + '>' + v['cntags'][i] + "</button>");
                                }
                                row += tags_btn.join("\r\n") + "</td></tr>";
                                $("#box-tags").append(row);
                            });
                            //if (lang !== 'cn') $('[data-toggle="tooltip"]').tooltip();
                            let tags_aval = {};
                            let all_chars = {};
                            let avg_char_tag = 0;
                            $.getJSON("/json/tool/mrfz/akhr.json", function (data) {
                                let tag_count = 0;
                                let char_tag_sum = 0;
                                // console.log(data);
                                $.each(data, function (_, char) {
                                    if (char.hidden) return;
                                    char.tags.push(char.type + "干员");
                                    let name = lang === 'cn' ? char.name : char["name-" + lang];
                                    $.each(char.tags, function (_, tag) {
                                        if (tag in tags_aval) {
                                            tags_aval[tag].push({ "name": name, "img": char["name-en"], "level": char.level, "type": char.type });
                                        } else {
                                            tags_aval[tag] = [{ "name": name, "img": char["name-en"], "level": char.level, "type": char.type }];
                                            tag_count++;
                                        }
                                        char_tag_sum++;
                                    });
                                    all_chars[name] = { 'level': char.level, 'tags': char.tags };
                                });
                                avg_char_tag = char_tag_sum / tag_count;
                            });
                            let showImage = getLocalStorage("hr-showImage", false);
                            let showName = getLocalStorage("hr-showName", true);
                            let imageSize = getLocalStorage("hr-imageSize",27);
                            function toggleBtnImage() {
                                $(".btn-image").toggleClass("btn-primary btn-secondary");
                                $(".btn-imgsize").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                                if ($(".btn-image").hasClass("btn-primary")) $(".btn-imgsize[sizeval=" + imageSize + "]").toggleClass("btn-primary btn-secondary");
                                showImage = $(".btn-image").hasClass("btn-primary");
                                setLocalStorage("hr-showImage", showImage);
                                setLocalStorage("hr-imageSize", imageSize);
                                if(initialized) calc();
                            }
                            function toggleBtnName() {
                                $(".btn-name").toggleClass("btn-primary btn-secondary");
                                showName = !showName;
                                setLocalStorage("ht-showName", showName);
                                if(initialized) calc();
                            }
                            if (showImage) { toggleBtnImage(); }
                            $(document).on("click", ".btn-name", toggleBtnName);
                            $(document).on("click", ".btn-image", toggleBtnImage);
                            $(document).on("click", ".btn-imgsize", function () {
                                if ($(this).hasClass("btn-primary")) {
                                    $(".btn-image").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                                    $(".btn-imgsize").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                                } else {
                                    imageSize = parseInt($(this).attr("sizeval"));
                                    $(".btn-image").removeClass("btn-primary btn-secondary").addClass("btn-primary");
                                    $(".btn-imgsize").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                                    $(this).toggleClass("btn-primary btn-secondary");
                                }
                                showImage = $(".btn-image").hasClass("btn-primary");
                                setLocalStorage("hr-showImage", showImage);
                                setLocalStorage("hr-imageSize", imageSize);
                                calc();
                            });
                            function calc() {
                                let len = checkedTags.length;
                                let count = Math.pow(2, checkedTags.length);
                                let combs = [];
                                for (let i = 0; i < count; i++) {
                                    let ts = [], tsTL = [];
                                    for (let j = 0, mask = 1; j < len; j++) {
                                        if ((i & mask) !== 0) {
                                            ts.push(checkedTags[j]);
                                            tsTL.push(checkedTagsTL[j]);
                                            // console.log(checkedTags[j]);
                                        }
                                        mask = mask * 2;
                                    }
                                    combs.push({ "tags": ts, "tagsTL": tsTL, "score": 0.0, "possible": [] });
                                }
                                // console.log(combs);
                                let optStars = [];
                                $(".btn-opt").each(function (_, __) {
                                    if ($(this).attr("opt-id") === "all" || $(this).hasClass("btn-secondary")) return;
                                    optStars.push($(this).attr("opt-id"));
                                });
                                //console.log(optStars);
                                $("#tbody-recommend").html("");
                                $.each(combs, function (_, comb) {
                                    let tags = comb.tags;
                                    if (tags.length === 0 || tags.length > 3) return;
                                    let chars = [...tags_aval[tags[0]]];
                                    for (let i = 1; i < tags.length; i++) {
                                        let reduced_chars = [];
                                        $.each(chars, function (_, char) {
                                            // console.log(tags_aval[tags[i]]);
                                            // console.log(char);
                                            $.each(tags_aval[tags[i]], function (_, tgch) {
                                                if (char.name === tgch.name) {
                                                    reduced_chars.push(char);
                                                    return false;
                                                }
                                            });
                                        });
                                        chars = reduced_chars;
                                    }
                                    if (chars.length === 0) return;
                                    if (!tags.includes("高级资深干员")) {
                                        // console.log(tags.join(",") + " 不含(高级)资深干员");
                                        let reduce6 = [];
                                        $.each(chars, function (_, char) {
                                            if (char.level !== 6) {
                                                reduce6.push(char);
                                            }
                                        });
                                        chars = reduce6;
                                    }
                                    let filtered_chars = [];
                                    $.each(chars, function (_, char) {
                                        //console.log(char.level);
                                        if (optStars.includes(char.level.toString())) {
                                            filtered_chars.push(char);
                                        }
                                    });
                                    chars = filtered_chars;
                                    comb.possible = chars;
                                    if (chars.length === 0) return;
                                    let s = 0;
                                    $.each(chars, (_, char) => {
                                        s += char.level;
                                    });
                                    s = s / chars.length;
                                    comb.score = s + 0.1 / tags.length + 0.9 / chars.length;
                                });
                                combs.sort(function (a, b) {
                                    return a.score > b.score ? -1 : (a.score < b.score ? 1 :
                                        (a.tags.length > b.tags.length ? 1 : (a.tags.length < b.tags.length ? -1 : 0)));
                                });
                                let no = 1;
                                $.each(combs, function (_, comb) {
                                    if (comb.possible.length === 0) return;
                                    let chars = comb.possible;
                                    let tags = comb.tags;
                                    let tagsTL = comb.tagsTL;
                                    let chars_html = [];
                                    let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };
                                    comb.possible.sort(function (a, b) {
                                        return a.level > b.level ? -1 : (a.level < b.level ? 1 : 0);
                                    });
                                    $.each(chars, function (_, char) {
                                        let padding = showName && imageSize < 60 ? "padding-right: 4px" : "padding-right: 1px";
                                        let style = showImage ? "style=\"border-radius: 5px;padding: 1px 1px;" + padding + ";\" " : "";
                                        let buttonstyle = imageSize > 25 ? "background-color: #AAA;border-radius: 4px;" : "background-color: transparent;border-radius: 4px;";
                                        chars_html.push("<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] + " btn-char my-1 d-none d-sm-inline\" " + style + "title=\"" + char.name + "\">");
                                        if (showImage) chars_html.push("<img style=\"" + buttonstyle + "\"height=\"" + imageSize + "\" width=\"" + imageSize + "\" src=\"/images/chara/" + char.img + ".png\">   ");
                                        if (imageSize > 60) chars_html.push("<div>");
                                        if (showName) chars_html.push(char.name);
                                        if (imageSize > 60) chars_html.push("</div>");
                                        chars_html.push("</button>\n");
                                        chars_html.push("<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] + " btn-char my-1 d-inline d-sm-none\" " + "title=\"" + char.name + "\">" + char.name + "</button>\n");
                                    });
                                    let tags_html = [];
                                    for (let i = 0; i < tags.length; i++) {
                                        if (lang === 'cn') {
                                            tags_html.push('<button type="button" class="btn btn-sm btn-secondary btn-char my-1">' +
                                                tags[i] + "</button>\n");
                                        } else {
                                            tags_html.push('<button type="button" class="btn btn-sm btn-secondary btn-char my-1' +
                                                ' btn-char my-1" data-toggle="tooltip" data-placement="top" title="' + tagsTL[i] + '">' +
                                                tags[i] + "</button>\n");
                                        }
                                    }
                                    $("#tbody-recommend").append(
                                        "<tr class=\"tr-recommd\">" +
                                        "<td class=\"py-2 d-none d-sm-table-cell\">" + no++ + "</td>" +
                                        "<td class=\"py-1\">" + tags_html.join("") + "</td><td class=\"py-1\">" + chars_html.join("") +
                                        "</td>" +
                                        "<td class=\"py-2 d-none d-sm-table-cell\">" + Math.floor(comb.score * 100) / 100 + "</td>" +
                                        "</tr>");
                                });
                                //if (lang !== 'cn') $('[data-toggle="tooltip"]').tooltip();
                            }
                            let hasHidden = false;
                            $(document).on("click", ".btn-char", function () {
                                if (!hasHidden) {
                                    let char_name = $(this).attr("title");
                                    $(".tr-recommd:not(:contains('" + char_name + "'))").hide();
                                    let char = all_chars[char_name];
                                    let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };
                                    let tags_html = [];
                                    $.each(char.tags, function (_, tag) {
                                        tags_html.push("<button type=\"button\" class=\"btn btn-sm btn-secondary btn-char my-1\">" +
                                            tag + "</button>\n")
                                    });
                                    $("#tbody-recommend").append(
                                        "<tr class=\"tr-chartag\">" +
                                        "<td class=\"py-2 d-none d-sm-table-cell\">#</td>" +
                                        "<td class=\"py-1\"><button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] +
                                        " btn-char my-1\">" + char_name + "</button>\n" +
                                        "</td><td class=\"py-1\">" + tags_html.join("") +
                                        "</td><td class=\"py-2 d-none d-sm-table-cell\">#</td></tr>");
                                } else {
                                    $(".tr-recommd").show();
                                    $(".tr-chartag").remove();
                                }
                                hasHidden = !hasHidden;
                            });
                            let checkedTags = [];
                            let checkedTagsTL = [];
                            $(document).on("click", ".btn-tag", function () {
                                let checked = $(this).hasClass("btn-primary");
                                let tag = $(this).text();
                                let tagTL = $(this).attr("data-original-title");
                                if (checked) {
                                    checkedTags = checkedTags.filter(function (v, _, __) {
                                        return v !== tag;
                                    });
                                    checkedTagsTL = checkedTagsTL.filter(function (v, _, __) {
                                        return v !== tagTL;
                                    });
                                } else {
                                    if (checkedTags.length >= 6) {
                                        alert({ "cn": "无法选择更多标签：最多6个。", "en": "No more tags: max 6." }[lang]);
                                        return;
                                    } else {
                                        checkedTags.push(tag);
                                        checkedTagsTL.push(tagTL);
                                    }
                                }
                                $(this).toggleClass("btn-primary btn-secondary");
                                calc();
                            });
                            $(document).on("click", ".btn-opt", function () {
                                $(this).toggleClass("btn-primary btn-secondary");
                                let checked = $(this).hasClass("btn-primary");
                                if ($(this).attr("id") === "opt-all") {
                                    $(".btn-opt").removeClass("btn-primary btn-secondary").addClass(
                                        checked ? "btn-primary" : "btn-secondary"
                                    );
                                } else {
                                    if ($("#opt-all").hasClass("btn-primary")) {
                                        $("#opt-all").toggleClass("btn-primary btn-secondary");
                                    } else {
                                        let checkedCount = 0;
                                        $(".btn-opt").each(function (_, __) {
                                            if ($(this).attr("id") === "opt-all") return;
                                            if ($(this).hasClass("btn-primary")) checkedCount++;
                                        });
                                        if (checkedCount === 6) $("#opt-all").toggleClass("btn-primary btn-secondary");
                                    }
                                }
                                calc();
                            });
                            $(document).on('click', '#btn-clear', function () {
                                $('.btn-tag').removeClass('btn-primary').addClass('btn-secondary');
                                $("#tbody-recommend").html("");
                                checkedTags = [];
                            });
                            initialized = true;
                            css();
                        });
                    </script>
                    <!--css-->
                    <script type="text/javascript">
                       function css(){
                            css1();
                            css2();
                       }
                       function css1(){
                            let link = document.createElement('link');
                            link.setAttribute('type','text/css');
                            link.setAttribute('rel','stylesheet');
                            link.setAttribute('href','/css/tool/mrfz/bootstrap.min.css');
                            document.head.appendChild(link);
                        }
                       function css2(){
                            let link = document.createElement('link');
                            link.setAttribute('type','text/css');
                            link.setAttribute('rel','stylesheet');
                            link.setAttribute('href','/css/tool/mrfz/multilingual.css');
                            document.head.appendChild(link);
                        }
                    </script>
                    <!--明日方舟公开招募计算器[20200210]-end-->
</body>
</html>